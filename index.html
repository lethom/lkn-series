<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>lkn In A Nutshell</title>
<!-- 2018-01-28 Sun 12:14 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="lthms &lt;contact@thomasletan.fr&gt;" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://www.pirilampo.org/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://www.pirilampo.org/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://www.pirilampo.org/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://www.pirilampo.org/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">lkn In A Nutshell</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. <i>lkn-core</i> Explained</a>
<ul>
<li><a href="#sec-1-1">1.1. ECS Reinterpretation</a></li>
<li><a href="#sec-1-2">1.2. Managing Game Scenes</a></li>
</ul>
</li>
<li><a href="#sec-2">2. The Most Complicated Chat-Server</a>
<ul>
<li><a href="#sec-2-1">2.1. Specification</a></li>
<li><a href="#sec-2-2">2.2. Mix Project</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
<i>lkn</i> is an experimental framework to write game server. It is written in Elixir
and leverages the OTP framework to build an actor-based implementation of the
Entity-Component-System (ECS) pattern. Whether <i>lkn</i> scales for realistic games
is still an open question, hence the “experimental.” The purpose of the present
document is to give an overview of the <a href="https://hex.pm/packages/lkn_core"><i>lkn-core</i></a> features. You can see it as a
tutorial, and a part of the framework documentation. It is also a literate
programming experiment which leverages Emacs org-mode. In you open this file in
Emacs, <code>M-x org-babel-tangle</code> will generate the project.
</p>

<p>
In short, <i>lkn-core</i> is a free and personal interpretation of an
“Elixir-flavour” ECS implementation should look like, on top of a game scene
management machinery.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> <i>lkn-core</i> Explained</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> ECS Reinterpretation</h3>
<div class="outline-text-3" id="text-1-1">
<p>
What is the Entity-Component-System pattern to begin with? My understanding is
that it is an approach to divide different aspects of a given gameplay into
several unit called systems. Each system takes care of one “function” of the
game. ECS tutorials often list the collision system, the trade system, the
battle system, and so on.
</p>

<p>
A game scene is populated by so-called Entities. There are various kind of
Entities: players, monsters, obstacles, traps… Systems manipulate Entities: the
collision system decides who moves and who stays put. The battle system dictates
who lives and who dies. Of course, not every Entity can move, or be hurt. A
house can stop a player, but rarely the latter can destroy the former with its
blade.
</p>

<p>
Components unify how Systems interact with Entities <i>and</i> to determine which
Entities take part in a given System. More precisely, each System declares a
dedicated Component, and if an Entity owns the Component of a System, it means
it takes part in this System.
</p>

<p>
In Object-Oriented Programming, the ECS pattern allows to use aggregation
instead of inheritance, i.e. components are objects an Entity owns, rather than
classes they inherit from.
</p>

<p>
Elixir is not an Object-Oriented language, and while <i>lkn-core</i> picks up the
main ideas of the ECS pattern, it implements it in a different way. In short,
Entities are a collection of properties, and Components act as proxies for
Systems to manipulate these properties.
</p>

<p>
This way, the internal organisation of each kind of Entities can be different
(and match, for instance, their persistent back-end structure), since the
Components abstract that in a unified way for the Systems. Also, two Components
can leverage the same property of a given Entity, meaning they can share
information. For instance, the battle system can access the entity position
managed by the collision system (e.g., to compute a list of potential targets).
</p>

<div class="warning">
<p>
Only one Component should modify a given property of its Entity, to avoid race
conditions and inconsistency. In earliest prototypes of <i>lkn-core</i>, this was
enforced by the framework, but this protection was dropped. As a consequence, it
is up to you to be careful.
</p>

</div>

<p>
Also, <i>lkn-core</i> distinguishes between two categories of Entities: Maps, and
Puppets. A Map is a game scene wherein Puppets can evolve. Because a Map is an
Entity, just like a player’s character is, it declares a list of
Components. This list of Components is used by the framework to determine which
Systems it needs to initiate for map in particular. That is, you can have a Map
which owns a Component dedicated to the battle system, and another which does
not.
</p>

<p>
Systems can act autonomously, e.g. a gravity system has always something to
do. However, a game without players can quickly become boring. Each System
expose an interface the player will use to inject their game choices (move,
attack, defend, etc.). In return, Systems will send back notifications to the
players, so that they can make now choices.
</p>

<p>
Of course, in this context, a “player” can be a human playing a character, but
it can also be an IA which manipulates a monsters pack. In <i>lkn-core</i>, playing
is done through puppets, and therefore, “players” are called Puppeteers.
</p>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Managing Game Scenes</h3>
<div class="outline-text-3" id="text-1-2">
<p>
<i>lkn-core</i> is about writing game server, and this means it needs to be able to
manage several game scenes at the same time, sometimes for the very same Map
(e.g. for dungeons). A <i>lkn-core</i> game scene is called an Instance. An Instance
gives life to a Map, by initiating the required Systems.
</p>

<p>
Instances come and go. When there is no room left for a player, a new instance
must be spawned. Then, when there is no player left inside an Instance, the
latter can die in peace.
</p>

<p>
The idea is the following: with a Map comes an Instances Pool. When a Puppeteer
wants to join an Instance of this Map, it asks for it to the dedicated Pool,
which returns one Instance (which might have been spawned just for the occasion,
but this is not the Puppeteer concern, and it is totally transparent). The
Puppeteer can then “register” its puppets to its new Instance. When it decides
to leave, it must unregister its puppets, then unregister itself. An Instance
can stay alive for a given amount of time even if it has no Puppeteer left. The
reason is simple: imagine a Map where a rare monster spawns one hour after its
last kill, we do not want to allow players to run into this monster whenever
only by going out and going in the Map.
</p>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> The Most Complicated Chat-Server</h2>
<div class="outline-text-2" id="text-2">
<p>
I suggest we proceed with a concrete example to demonstrate how <i>lkn-core</i> can
be leveraged to write a server.
</p>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Specification</h3>
<div class="outline-text-3" id="text-2-1">
<p>
To illustrate <i>lkn-core</i> features, a good example is a chat server. Basically,
we want to be able to:
</p>

<ol class="org-ol">
<li>Join the <code>#default</code> chat-room when we connect to the server
</li>
<li>Change our nickname
</li>
<li>Chat (it is a chat-server after all)
</li>
<li>Join another chat-room, considering that:
<ul class="org-ul">
<li><code>#default</code> and <code>#spam</code> have no chatter limits, but <code>#dungeon</code> can have at
most 3 players at the given time
</li>
<li><code>#dungeon</code> stays alive 2 minutes after the last player leaves
</li>
</ul>
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> Mix Project</h3>
<div class="outline-text-3" id="text-2-2">
<p>
We first configure our Mix project, so we can hack our way through this
chat-server. <i>lkn-core</i> has been published to <a href="https://hex.pm/packages/lkn_core">hex.pm</a>, so it is easy to use
it. In addition, it is recommended to use it with <i>lkn-prelude</i>. This might
change in the future, because <i>lkn-prelude</i> only brings a type-like <code>Option</code>
similar to Haskell <code>Maybe</code>.
</p>

<div class="org-src-container">

<pre class="src src-elixir" id="lkn-dependencies">{:lkn_core, "~&gt; 0.4.1"},
{:lkn_prelude, "~&gt; 0.1.2"},
</pre>
</div>

<p>
Then, <i>lkn-core</i> heavily rely on so-called keys to inter-process
communication. That is, you should not need to use directly a PID of a <i>lkn</i>
process. The <code>uuid</code> package provides a function to generate a random UUID, so we
will use that when we need randomness.
</p>

<div class="org-src-container">

<pre class="src src-elixir" id="other-dependencies">{:uuid, "~&gt; 1.1"},
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: lthms &lt;contact@thomasletan.fr&gt;</p>
<p class="date">Created: 2018-01-28 Sun 12:14</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
